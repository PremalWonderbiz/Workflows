name: generic-ci

on:
  workflow_call:
    secrets:
      SONAR_HOST_URL:
        required: true
      SONAR_TOKEN:
        required: true
      SONAR_ORG:
        required: false
    inputs:
      backend_sonar_key:
        type: string
        required: true
      frontend_sonar_key:
        type: string
        required: true

jobs:
  sonar-analysis:
    runs-on: ubuntu-latest

    steps:
      # ==========================================================
      # CHECKOUT
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==========================================================
      # INSTALL RUNTIMES
      # ==========================================================
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Install SonarScanner
        run: dotnet tool install --global dotnet-sonarscanner


      # ==========================================================
      # LOAD CONFIG
      # ==========================================================
      - name: Load Configurations
        id: config
        run: |
          CONFIG="Configurations/project-config.yml"
      
          echo "backend=$(yq -o=json -I=0 '.backendServices' $CONFIG)" >> $GITHUB_OUTPUT
          echo "frontend=$(yq -o=json -I=0 '.frontendProjects' $CONFIG)" >> $GITHUB_OUTPUT
          echo "backendSonarRaw=$(yq '.settings.backend.sonar' $CONFIG)" >> $GITHUB_OUTPUT
          echo "frontendSonarRaw=$(yq '.settings.frontend.sonar' $CONFIG)" >> $GITHUB_OUTPUT
      
          echo "=== DEBUG PRINTS FROM Load Configurations ==="
          echo "backendServices:"
          yq -o=json -I=0 '.backendServices' $CONFIG
      
          echo "frontendProjects:"
          yq -o=json -I=0 '.frontendProjects' $CONFIG
      
          echo "backend.sonar:"
          yq '.settings.backend.sonar' $CONFIG
      
          echo "frontend.sonar:"
          yq '.settings.frontend.sonar' $CONFIG

      # ==========================================================
      # DETECT CHANGES (AUTO-ENABLE BACKEND/FRONTEND SONAR)
      # ==========================================================
      - name: Detect Changed Backend/Frontend Projects
        id: detect_changes
        shell: pwsh
        run: |
          Write-Host "Detecting changed files..."

          # Get list of changed files in PR or push
          $changedFiles = git diff --name-only HEAD~1 HEAD

          Write-Host "Changed files:"
          Write-Host $changedFiles

          # Parse config
          $configJson = yq -o=json '.' Configurations/project-config.yml
          $config = $configJson | ConvertFrom-Json

          $backendChanged = $false
          $frontendChanged = $false

          # -----------------------------------
          # Detect backend changes
          # -----------------------------------
          foreach ($svc in $config.backendServices) {
            $path = $svc.path.Replace("\", "/")
            if ($changedFiles -match $path) {
              Write-Host "Backend project changed: $($svc.name)"
              $backendChanged = $true
            }
          }

          # -----------------------------------
          # Detect frontend changes
          # -----------------------------------
          foreach ($svc in $config.frontendProjects) {
            $path = $svc.path.Replace("\", "/")
            if ($changedFiles -match $path) {
              Write-Host "Frontend project changed: $($svc.name)"
              $frontendChanged = $true
            }
          }

          # Output results (true/false)
          echo "backendChanged=$backendChanged"   >> $env:GITHUB_OUTPUT
          echo "frontendChanged=$frontendChanged" >> $env:GITHUB_OUTPUT

          Write-Host "backendChanged = $backendChanged"
          Write-Host "frontendChanged = $frontendChanged"

      # ==========================================================
      # VALIDATION (CRITICAL)
      # ==========================================================
      - name: Validate Configuration
        id: validate
        shell: pwsh
        run: | 
          # 1. Check config file exists
          if (-not (Test-Path "Configurations/project-config.yml")) {
            Write-Error "Missing Configurations/project-config.yml. Cannot continue."
            exit 1
          }

          # Load YAML
          $configJson = yq -o=json '.' Configurations/project-config.yml
          $config = $configJson | ConvertFrom-Json

          # =====================================================
          # BACKEND VALIDATION
          # =====================================================
          $backendSonar = "${{ steps.config.outputs.backendSonarRaw }}"
          if ($backendSonar -eq "" -or $null -eq $backendSonar) {
            Write-Host "settings.backend.sonar not found ‚Üí treating as false"
            $backendSonar = "false"
          }
          echo "backendSonar=$backendSonar" >> $env:GITHUB_OUTPUT

          if ($backendSonar -eq "true") {
            # Must have services
            if (-not $config.backendServices -or $config.backendServices.Count -eq 0) {
              Write-Warning "backendServices is empty ‚Üí skipping backend sonar"
              echo "skipBackendSonar=true" >> $env:GITHUB_OUTPUT
            }

            # Must have backend sonar config
            if (-not (Test-Path "Configurations/sonar/SonarQube.Analysis.xml")) {
              Write-Error "Missing backend sonar config: Configurations/sonar/SonarQube.Analysis.xml"
              exit 1
            }
          }

          # Skip backend sonar of no changes detected
          $backendChanged = "${{ steps.detect_changes.outputs.backendChanged }}"
          if ($backendSonar -eq "true" -and $backendChanged -eq "True") {
            Write-Host "Backend sonar enabled AND backend changed ‚Üí will run backend sonar"
          }
          else {
            Write-Host "Backend sonar disabled or no backend changes ‚Üí skipping backend sonar"
            echo "skipBackendSonar=true" >> $env:GITHUB_OUTPUT
          }

          # =====================================================
          # FRONTEND VALIDATION
          # =====================================================
          $frontendSonar = "${{ steps.config.outputs.frontendSonarRaw }}"
          if ($frontendSonar -eq "" -or $null -eq $frontendSonar) {
            Write-Host "settings.frontend.sonar not found ‚Üí treating as false"
            $frontendSonar = "false"
          }
          echo "frontendSonar=$frontendSonar" >> $env:GITHUB_OUTPUT

          if ($frontendSonar -eq "true") {
            # Must have projects
            if (-not $config.frontendProjects -or $config.frontendProjects.Count -eq 0) {
              Write-Warning "frontendProjects empty ‚Üí skipping frontend sonar"
              echo "skipFrontendSonar=true" >> $env:GITHUB_OUTPUT
            }

            # Must have frontend sonar config
            if (-not (Test-Path "Configurations/sonar/FrontendSonarAnalysis/sonar-project.properties")) {
              Write-Warning "Missing frontend sonar config ‚Üí skipping frontend sonar"
              echo "skipFrontendSonar=true" >> $env:GITHUB_OUTPUT
            }
          }

          $frontendChanged = "${{ steps.detect_changes.outputs.frontendChanged }}"
          if ($frontendSonar -eq "true" -and $frontendChanged -eq "True") {
            Write-Host "Frontend sonar enabled AND frontend changed ‚Üí will run frontend sonar"
          }
          else {
            Write-Host "Frontend sonar disabled or no frontend changes ‚Üí skipping frontend sonar"
            echo "skipFrontendSonar=true" >> $env:GITHUB_OUTPUT
          }

          Write-Host "Validation completed."


      # ==========================================================
      # BACKEND SONAR
      # ==========================================================
      - name: Sonar Begin (Backend)
        if: ${{ steps.validate.outputs.backendSonar == 'true' && steps.validate.outputs.skipBackendSonar != 'true' }}
        shell: pwsh
        run: |
          # Read backend list (produced by previous Load Config step)
          $services = '${{ steps.config.outputs.backend }}' | ConvertFrom-Json
          $configPath = Join-Path $env:GITHUB_WORKSPACE "Configurations/sonar/SonarQube.Analysis.xml"
      
          # Build inclusions list from each service.path
          $inclusionsList = @()
          foreach ($svc in $services) {
            # normalize slashes and add recursive glob
            $p = ($svc.path).Replace("\", "/").TrimEnd("/")
            # choose pattern you want Sonar to analyze (folder recursive)
            $inclusionsList += "$p/**"
          }
      
          # If nothing, leave it empty (sonar default)
          $inclusions = ""
          if ($inclusionsList.Count -gt 0) {
            $inclusions = $inclusionsList -join ","
          }
      
          Write-Host "Computed sonar.inclusions: $inclusions"
      
          # Run Sonar Begin with inclusions (if any)
          if ([string]::IsNullOrEmpty($inclusions)) {
            dotnet-sonarscanner begin `
              /k:"${{ inputs.backend_sonar_key }}" `
              /o:"${{ secrets.SONAR_ORG }}" `
              /d:sonar.host.url="${{ secrets.SONAR_HOST_URL }}" `
              /d:sonar.login="${{ secrets.SONAR_TOKEN }}" `
              /s:"$configPath"
          } else {
            dotnet-sonarscanner begin `
              /k:"${{ inputs.backend_sonar_key }}" `
              /o:"${{ secrets.SONAR_ORG }}" `
              /d:sonar.host.url="${{ secrets.SONAR_HOST_URL }}" `
              /d:sonar.login="${{ secrets.SONAR_TOKEN }}" `
              /d:sonar.inclusions="$inclusions" `
              /s:"$configPath"
          }

      - name: Build & Test Backend Services
        if: ${{ steps.validate.outputs.backendSonar == 'true' && steps.validate.outputs.skipBackendSonar != 'true' }}
        shell: pwsh
        run: |
          $services = '${{ steps.config.outputs.backend }}' | ConvertFrom-Json

          foreach ($svc in $services) {
            Write-Host "Backend service: $($svc.name)"
            $path = $svc.path

            # Find .sln file
            $sln = Get-ChildItem -Path $path -Filter *.sln | Select-Object -First 1

            if (-not $sln) {
              Write-Warning "No .sln found for '$($svc.name)' ‚Üí skipping"
              continue
            }

            dotnet restore $sln.FullName
            dotnet build $sln.FullName --no-restore --configuration Release
            dotnet test $sln.FullName --no-restore `
              /p:CollectCoverage=true `
              /p:CoverletOutputFormat=opencover `
              /p:CoverletOutput=./TestResults/
          }


      - name: Sonar End (Backend)
        if: ${{ steps.validate.outputs.backendSonar == 'true' && steps.validate.outputs.skipBackendSonar != 'true' }}
        run: dotnet-sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"

      # ==========================================================
      # FRONTEND SONAR
      # ==========================================================
      - name: Sonar Scan (Frontend)
        if: ${{ steps.validate.outputs.frontendSonar == 'true' && steps.validate.outputs.skipFrontendSonar != 'true' }}
        shell: pwsh
        run: |
          # Load frontend project list
          $services = '${{ steps.config.outputs.frontend }}' | ConvertFrom-Json
      
          # Use existing analysis folder
          $analysisDir = Join-Path $env:GITHUB_WORKSPACE "Configurations/sonar/FrontendSonarAnalysis"
          $propsFile = "$analysisDir/sonar-project.properties"
      
          if (-not (Test-Path $propsFile)) {
            Write-Error "sonar-project.properties is missing at: $propsFile"
            exit 1
          }
      
          # Build each project first
          foreach ($svc in $services) {
            Write-Host "Building frontend project: $($svc.name)"
            $mfePath = Join-Path $env:GITHUB_WORKSPACE $svc.path
      
            if (-not (Test-Path $mfePath)) {
              Write-Warning "MFE path missing: $mfePath"
              continue
            }
      
            cd $mfePath
      
            if (Test-Path "package-lock.json") {
              npm ci
            } else {
              npm install
            }
      
            if (Test-Path "package.json") {
              # build
              if ((npm run | Select-String -Pattern "build")) {
                npm run build
              } else {
                Write-Warning "No build script for project $($svc.name)"
              }
      
              # tests
              if ((npm run | Select-String -Pattern "test")) {
                npm test -- --coverage
              } else {
                Write-Warning "No test script for project $($svc.name)"
              }
            }
      
            cd $analysisDir
          }
      
          # Build dynamic sources for sonar
          $sourceList = @()
          foreach ($svc in $services) {
            $src = "$($svc.path)/src".Replace("\", "/")
            $sourceList += $src
          }
      
          $sources = ($sourceList -join ",")
      
          $baseDir = "$env:GITHUB_WORKSPACE".Replace("\", "/")
      
          Write-Host "Updating sonar-project.properties for all MFEs..."
      
          (Get-Content $propsFile |
            Where-Object {
              -not ($_ -match "^sonar\.projectBaseDir=") -and
              -not ($_ -match "^sonar\.sources=")        -and
              -not ($_ -match "^sonar\.tests=")
            }) |
            Set-Content $propsFile
      
          @"
          sonar.projectBaseDir=$baseDir
          sonar.sources=$sources
          sonar.tests=$sources
          "@ | Add-Content $propsFile
      
          Write-Host "Updated sonar-project.properties:"
          Get-Content $propsFile
      
          $env:SONAR_TOKEN    = "${{ secrets.SONAR_TOKEN }}"
          $env:SONAR_HOST_URL = "${{ secrets.SONAR_HOST_URL }}"
      
          # ---------------------------
          # Run Sonar
          # ---------------------------
          npx sonar-scanner `
            "-Dsonar.projectKey=${{ inputs.frontend_sonar_key }}" `
            "-Dsonar.organization=${{ secrets.SONAR_ORG }}" `
            "-Dsonar.host.url=$env:SONAR_HOST_URL" `
            "-Dsonar.token=$env:SONAR_TOKEN"


      # ==========================================================
      # GITHUB_STEP_SUMMARY
      # ==========================================================
      - name: Add SonarQube Report Links to Summary
        if: always()
        shell: pwsh
        run: |
          # Build URLs
          $backendKey  = "${{ inputs.backend_sonar_key }}"
          $frontendKey = "${{ inputs.frontend_sonar_key }}"
      
          $backendUrl  = "https://sonarcloud.io/project/overview?id=$backendKey"
          $frontendUrl = "https://sonarcloud.io/project/overview?id=$frontendKey"
      
          # ==========================
          # HEADER
          # ==========================
          Add-Content $env:GITHUB_STEP_SUMMARY "# üîç SonarQube Analysis Summary"
          Add-Content $env:GITHUB_STEP_SUMMARY ""
      
          # ==========================
          # BACKEND ANALYSIS SECTION
          # ==========================
          Add-Content $env:GITHUB_STEP_SUMMARY "## Backend Analysis"
      
          Add-Content $env:GITHUB_STEP_SUMMARY "### Project Key"
          Add-Content $env:GITHUB_STEP_SUMMARY "```"
          Add-Content $env:GITHUB_STEP_SUMMARY "$backendKey"
          Add-Content $env:GITHUB_STEP_SUMMARY "```"
      
          Add-Content $env:GITHUB_STEP_SUMMARY "- **Report URL:** [$backendUrl]($backendUrl)"
          Add-Content $env:GITHUB_STEP_SUMMARY ""
      
          # ==========================
          # FRONTEND ANALYSIS SECTION
          # ==========================
          Add-Content $env:GITHUB_STEP_SUMMARY "## Frontend Analysis"
      
          Add-Content $env:GITHUB_STEP_SUMMARY "### Project Key"
          Add-Content $env:GITHUB_STEP_SUMMARY "```"
          Add-Content $env:GITHUB_STEP_SUMMARY "$frontendKey"
          Add-Content $env:GITHUB_STEP_SUMMARY "```"
      
          Add-Content $env:GITHUB_STEP_SUMMARY "- **Report URL:** [$frontendUrl]($frontendUrl)"
          Add-Content $env:GITHUB_STEP_SUMMARY ""
      
          # ==========================
          # FOOTER
          # ==========================
          Add-Content $env:GITHUB_STEP_SUMMARY "üìù Click the links above to view code smells, bugs, vulnerabilities, and coverage."
