name: generic-ci

on:
  workflow_call:
    secrets:
      SONAR_HOST_URL:
        required: true
      SONAR_TOKEN:
        required: true
    inputs:
      backend_sonar_key:
        type: string
        required: true
      frontend_sonar_key:
        type: string
        required: true

jobs:
  sonar-analysis:
    runs-on: ubuntu-latest

    steps:
      # ==========================================================
      # CHECKOUT
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==========================================================
      # INSTALL RUNTIMES
      # ==========================================================
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Install SonarScanner
        run: dotnet tool install --global dotnet-sonarscanner


      # ==========================================================
      # LOAD CONFIG
      # ==========================================================
      - name: Load Configurations
        id: config
        run: |
          CONFIG="Configurations/project-config.yml"
      
          echo "backend=$(yq -o=json -I=0 '.backendServices' $CONFIG)" >> $GITHUB_OUTPUT
          echo "frontend=$(yq -o=json -I=0 '.frontendProjects' $CONFIG)" >> $GITHUB_OUTPUT
          echo "backendSonarRaw=$(yq '.settings.backend.sonar' $CONFIG)" >> $GITHUB_OUTPUT
          echo "frontendSonarRaw=$(yq '.settings.frontend.sonar' $CONFIG)" >> $GITHUB_OUTPUT
      
          echo "=== DEBUG PRINTS FROM Load Configurations ==="
          echo "backendServices:"
          yq -o=json -I=0 '.backendServices' $CONFIG
      
          echo "frontendProjects:"
          yq -o=json -I=0 '.frontendProjects' $CONFIG
      
          echo "backend.sonar:"
          yq '.settings.backend.sonar' $CONFIG
      
          echo "frontend.sonar:"
          yq '.settings.frontend.sonar' $CONFIG

      # ==========================================================
      # VALIDATION (CRITICAL)
      # ==========================================================
      - name: Validate Configuration
        id: validate
        shell: pwsh
        run: | 
          # 1. Check config file exists
          if (-not (Test-Path "Configurations/project-config.yml")) {
            Write-Error "Missing Configurations/project-config.yml. Cannot continue."
            exit 1
          }

          # Load YAML
          $configJson = yq -o=json '.' Configurations/project-config.yml
          $config = $configJson | ConvertFrom-Json

          # =====================================================
          # BACKEND VALIDATION
          # =====================================================
          $backendSonar = "${{ steps.config.outputs.backendSonarRaw }}"
          if ($backendSonar -eq "" -or $null -eq $backendSonar) {
            Write-Host "settings.backend.sonar not found → treating as false"
            $backendSonar = "false"
          }
          echo "backendSonar=$backendSonar" >> $env:GITHUB_OUTPUT

          if ($backendSonar -eq "true") {
            # Must have services
            if (-not $config.backendServices -or $config.backendServices.Count -eq 0) {
              Write-Warning "backendServices is empty → skipping backend sonar"
              echo "skipBackendSonar=true" >> $env:GITHUB_OUTPUT
            }

            # Must have backend sonar config
            if (-not (Test-Path "Configurations/sonar/SonarQube.Analysis.xml")) {
              Write-Error "Missing backend sonar config: Configurations/sonar/SonarQube.Analysis.xml"
              exit 1
            }
          }

          # =====================================================
          # FRONTEND VALIDATION
          # =====================================================
          $frontendSonar = "${{ steps.config.outputs.frontendSonarRaw }}"
          if ($frontendSonar -eq "" -or $null -eq $frontendSonar) {
            Write-Host "settings.frontend.sonar not found → treating as false"
            $frontendSonar = "false"
          }
          echo "frontendSonar=$frontendSonar" >> $env:GITHUB_OUTPUT

          if ($frontendSonar -eq "true") {
            # Must have projects
            if (-not $config.frontendProjects -or $config.frontendProjects.Count -eq 0) {
              Write-Warning "frontendProjects empty → skipping frontend sonar"
              echo "skipFrontendSonar=true" >> $env:GITHUB_OUTPUT
            }

            # Must have frontend sonar config
            if (-not (Test-Path "Configurations/sonar/FrontendSonarAnalysis/sonar-project.properties")) {
              Write-Warning "Missing frontend sonar config → skipping frontend sonar"
              echo "skipFrontendSonar=true" >> $env:GITHUB_OUTPUT
            }
          }

          Write-Host "Validation completed."


      # ==========================================================
      # BACKEND SONAR
      # ==========================================================
      - name: Sonar Begin (Backend)
        if: ${{ steps.validate.outputs.backendSonar == 'true' && steps.validate.outputs.skipBackendSonar != 'true' }}
        run: |
          dotnet-sonarscanner begin \
            /k:"${{ inputs.backend_sonar_key }}" \
            /d:sonar.host.url="${{ secrets.SONAR_HOST_URL }}" \
            /d:sonar.login="${{ secrets.SONAR_TOKEN }}" \
            /s:"${GITHUB_WORKSPACE}/Configurations/sonar/SonarQube.Analysis.xml"


      - name: Build & Test Backend Services
        if: ${{ steps.validate.outputs.backendSonar == 'true' && steps.validate.outputs.skipBackendSonar != 'true' }}
        shell: pwsh
        run: |
          $services = '${{ steps.config.outputs.backend }}' | ConvertFrom-Json

          foreach ($svc in $services) {
            Write-Host "Backend service: $($svc.name)"
            $path = $svc.path

            # Find .sln file
            $sln = Get-ChildItem -Path $path -Filter *.sln | Select-Object -First 1

            if (-not $sln) {
              Write-Warning "No .sln found for '$($svc.name)' → skipping"
              continue
            }

            dotnet restore $sln.FullName
            dotnet build $sln.FullName --no-restore --configuration Release
            dotnet test $sln.FullName --no-restore `
              /p:CollectCoverage=true `
              /p:CoverletOutputFormat=opencover `
              /p:CoverletOutput=./TestResults/
          }


      - name: Sonar End (Backend)
        if: ${{ steps.validate.outputs.backendSonar == 'true' && steps.validate.outputs.skipBackendSonar != 'true' }}
        run: dotnet-sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"

      # ==========================================================
      # FRONTEND SONAR
      # ==========================================================
      - name: Sonar Scan (Frontend)
        if: ${{ steps.validate.outputs.frontendSonar == 'true' && steps.validate.outputs.skipFrontendSonar != 'true' }}
        shell: pwsh
        run: |
          # Load frontend project list from config
          $services = '${{ steps.config.outputs.frontend }}' | ConvertFrom-Json
      
          # Use existing analysis folder and properties file
          $analysisDir = "${GITHUB_WORKSPACE}/Configurations/sonar/FrontendSonarAnalysis"
          $propsFile = "$analysisDir/sonar-project.properties"
      
          if (-not (Test-Path $propsFile)) {
            Write-Error "sonar-project.properties is missing at: $propsFile"
            exit 1
          }
      
          # Install sonar-scanner locally inside analysis directory
          cd $analysisDir
          npm install sonar-scanner --save-dev | Out-Null
      
          # Build dynamic MFE source list
          $sourceList = @()
          foreach ($svc in $services) {
            $src = "$($svc.path)/src".Replace("\", "/")
            $sourceList += $src
          }
      
          # Multi-project sources → comma separated
          $sources = ($sourceList -join ",")
      
          # Recommended base directory = repo root
          $baseDir = "${GITHUB_WORKSPACE}".Replace("\", "/")
      
          Write-Host "Updating sonar-project.properties for all MFEs..."
      
          # Remove old dynamic entries if exist
          (Get-Content $propsFile |
            Where-Object {
              -not ($_ -match "^sonar\.projectBaseDir=") -and
              -not ($_ -match "^sonar\.sources=")        -and
              -not ($_ -match "^sonar\.tests=")
            }) |
            Set-Content $propsFile
      
          # Append dynamic values
          @"
          sonar.projectBaseDir=$baseDir
          sonar.sources=$sources
          sonar.tests=$sources
          "@ | Add-Content $propsFile
      
          Write-Host "Updated sonar-project.properties:"
          Get-Content $propsFile
      
          # Set sonar auth safely (env only)
          $env:SONAR_TOKEN    = "${{ secrets.SONAR_TOKEN }}"
          $env:SONAR_HOST_URL = "${{ secrets.SONAR_HOST_URL }}"

          # Run ONE scan
          npm exec sonar-scanner `
            -Dsonar.host.url="$env:SONAR_HOST_URL" `
            -Dsonar.login="$env:SONAR_TOKEN"     
