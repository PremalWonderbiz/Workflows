name: generic-ci

on:
  workflow_call:
    secrets:
      SONAR_TOKEN:
        required: true
      COVERITY_BACKEND_PROJECT_TOKEN:
        required: true
      COVERITY_FRONTEND_PROJECT_TOKEN:
        required: true
    inputs:
      backend_sonar_key:
        type: string
        required: true
      frontend_sonar_key:
        type: string
        required: true
      SONAR_HOST_URL:
        type: string
        required: true
      SONAR_ORG:
        type: string
        required: true
      COVERITY_EMAIL:
        type: string
        required: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend_changed: ${{ steps.changes.outputs.backendChanged }}
      frontend_changed: ${{ steps.changes.outputs.frontendChanged }}

    steps:
      # ==========================================================
      # CHECKOUT
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # ==========================================================
      # DETECT CHANGES (AUTO-ENABLE BACKEND/FRONTEND SONAR)
      # ==========================================================
      - name: Detect Changed Backend/Frontend Projects
        id: changes
        shell: pwsh
        run: |
          Write-Host "Detecting changed files..."

          # Get list of changed files in PR or push
          $changedFiles = git diff --name-only HEAD~1 HEAD

          Write-Host "Changed files:"
          Write-Host $changedFiles

          # Parse config
          $configJson = yq -o=json '.' Configurations/project-config.yml
          $config = $configJson | ConvertFrom-Json

          $backendChanged = $false
          $frontendChanged = $false

          # -----------------------------------
          # Detect backend changes
          # -----------------------------------
          foreach ($svc in $config.backendServices) {
            $path = $svc.path.Replace("\", "/")
            if ($changedFiles -match $path) {
              Write-Host "Backend project changed: $($svc.name)"
              $backendChanged = $true
            }
          }

          # -----------------------------------
          # Detect frontend changes
          # -----------------------------------
          foreach ($svc in $config.frontendProjects) {
            $path = $svc.path.Replace("\", "/")
            if ($changedFiles -match $path) {
              Write-Host "Frontend project changed: $($svc.name)"
              $frontendChanged = $true
            }
          }

          # Output results (true/false)
          echo "backendChanged=$backendChanged"   >> $env:GITHUB_OUTPUT
          echo "frontendChanged=$frontendChanged" >> $env:GITHUB_OUTPUT

          Write-Host "backendChanged = $backendChanged"
          Write-Host "frontendChanged = $frontendChanged"
          
          
  load-validate-configuration:
    needs: detect-changes
    runs-on: ubuntu-latest
    outputs:
      skipBackendSonar: ${{ steps.validate.outputs.skipBackendSonar }}
      skipBackendCoverity: ${{ steps.validate.outputs.skipBackendCoverity }}
      skipFrontendSonar: ${{ steps.validate.outputs.skipFrontendSonar }}
      skipFrontendCoverity: ${{ steps.validate.outputs.skipFrontendCoverity }}
      backendServices: ${{ steps.config.outputs.backend }}
      frontendProjects: ${{ steps.config.outputs.frontend }}

    steps:
      # ==========================================================
      # CHECKOUT
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      # ==========================================================
      # LOAD CONFIG
      # ==========================================================
      - name: Load Configurations
        id: config
        run: |
          CONFIG="Configurations/project-config.yml"
      
          echo "backend=$(yq -o=json -I=0 '.backendServices' $CONFIG)" >> $GITHUB_OUTPUT
          echo "frontend=$(yq -o=json -I=0 '.frontendProjects' $CONFIG)" >> $GITHUB_OUTPUT
          echo "backendSonarRaw=$(yq '.settings.backend.sonar' $CONFIG)" >> $GITHUB_OUTPUT
          echo "frontendSonarRaw=$(yq '.settings.frontend.sonar' $CONFIG)" >> $GITHUB_OUTPUT
          echo "backendCoverityRaw=$(yq '.settings.backend.coverity' $CONFIG)" >> $GITHUB_OUTPUT
          echo "frontendCoverityRaw=$(yq '.settings.frontend.coverity' $CONFIG)" >> $GITHUB_OUTPUT
      
          echo "=== DEBUG PRINTS FROM Load Configurations ==="
          echo "backendServices:"
          yq -o=json -I=0 '.backendServices' $CONFIG
      
          echo "frontendProjects:"
          yq -o=json -I=0 '.frontendProjects' $CONFIG
      
          echo "backend.sonar:"
          yq '.settings.backend.sonar' $CONFIG
      
          echo "frontend.sonar:"
          yq '.settings.frontend.sonar' $CONFIG
          
      # ==========================================================
      # VALIDATION (CRITICAL)
      # ==========================================================
      - name: Validate Configuration
        id: validate
        shell: pwsh
        run: | 
          # 1. Check config file exists
          if (-not (Test-Path "Configurations/project-config.yml")) {
            Write-Error "Missing Configurations/project-config.yml. Cannot continue."
            exit 1
          }

          # Load YAML
          $configJson = yq -o=json '.' Configurations/project-config.yml
          $config = $configJson | ConvertFrom-Json

          # =====================================================
          # BACKEND VALIDATION
          # =====================================================
          $backendSonar = "${{ steps.config.outputs.backendSonarRaw }}"
          if ($backendSonar -eq "" -or $null -eq $backendSonar) {
            Write-Host "settings.backend.sonar not found ‚Üí treating as false"
            $backendSonar = "false"
          }
          echo "backendSonar=$backendSonar" >> $env:GITHUB_OUTPUT
    
          if ($backendSonar -eq "true") {
            # Must have services
            if (-not $config.backendServices -or $config.backendServices.Count -eq 0) {
              Write-Warning "backendServices is empty ‚Üí skipping backend sonar"
              echo "skipBackendSonar=true" >> $env:GITHUB_OUTPUT
            }

            # Must have backend sonar config
            if (-not (Test-Path "Configurations/sonar/SonarQube.Analysis.xml")) {
              Write-Error "Missing backend sonar config: Configurations/sonar/SonarQube.Analysis.xml"
              exit 1
            }
          }
          
          $backendCoverity = "${{ steps.config.outputs.backendCoverityRaw }}"
          if ($backendCoverity -eq "" -or $null -eq $backendCoverity) {
            Write-Host "settings.backend.coverity not found ‚Üí treating as false"
            $backendCoverity = "false"
          }
          echo "backendCoverity=$backendCoverity" >> $env:GITHUB_OUTPUT
    
          if ($backendCoverity -eq "true") {
            # Must have services
            if (-not $config.backendServices -or $config.backendServices.Count -eq 0) {
              Write-Warning "backendServices is empty ‚Üí skipping backend Coverity"
              echo "skipBackendCoverity=true" >> $env:GITHUB_OUTPUT
            }
          }

          # Skip backend sonar if no changes detected
          $backendChanged = "${{ needs.detect-changes.outputs.backend_changed }}"
          if ($backendSonar -eq "true" -and $backendChanged -eq "True") {
            Write-Host "Backend sonar enabled AND backend changed ‚Üí will run backend sonar"
          }
          else {
            Write-Host "Backend sonar disabled or no backend changes ‚Üí skipping backend sonar"
            echo "skipBackendSonar=true" >> $env:GITHUB_OUTPUT
          }
          
          # Skip backend coverity if no changes detected
          if ($backendSonar -eq "true" -and $backendChanged -eq "True") {
            Write-Host "Backend coverity enabled AND backend changed ‚Üí will run backend coverity"
          }
          else {
            Write-Host "Backend coverity disabled or no backend changes ‚Üí skipping backend coverity"
            echo "skipBackendCoverity=true" >> $env:GITHUB_OUTPUT
          }

          # =====================================================
          # FRONTEND VALIDATION
          # =====================================================
          $frontendSonar = "${{ steps.config.outputs.frontendSonarRaw }}"
          if ($frontendSonar -eq "" -or $null -eq $frontendSonar) {
            Write-Host "settings.frontend.sonar not found ‚Üí treating as false"
            $frontendSonar = "false"
          }
          echo "frontendSonar=$frontendSonar" >> $env:GITHUB_OUTPUT

          if ($frontendSonar -eq "true") {
            # Must have projects
            if (-not $config.frontendProjects -or $config.frontendProjects.Count -eq 0) {
              Write-Warning "frontendProjects empty ‚Üí skipping frontend sonar"
              echo "skipFrontendSonar=true" >> $env:GITHUB_OUTPUT
            }

            # Must have frontend sonar config
            if (-not (Test-Path "Configurations/sonar/FrontendSonarAnalysis/sonar-project.properties")) {
              Write-Warning "Missing frontend sonar config ‚Üí skipping frontend sonar"
              echo "skipFrontendSonar=true" >> $env:GITHUB_OUTPUT
            }
          }
          
          $frontendCoverity = "${{ steps.config.outputs.frontendCoverityRaw }}"
          if ($frontendCoverity -eq "" -or $null -eq $frontendCoverity) {
            Write-Host "settings.frontend.coverity not found ‚Üí treating as false"
            $frontendCoverity = "false"
          }
          echo "frontendCoverity=$frontendCoverity" >> $env:GITHUB_OUTPUT

          if ($frontendCoverity -eq "true") {
            # Must have projects
            if (-not $config.frontendProjects -or $config.frontendProjects.Count -eq 0) {
              Write-Warning "frontendProjects empty ‚Üí skipping frontend sonar"
              echo "skipFrontendCoverity=true" >> $env:GITHUB_OUTPUT
            }
          }

          $frontendChanged = "${{ needs.detect-changes.outputs.frontend_changed }}"
          if ($frontendSonar -eq "true" -and $frontendChanged -eq "True") {
            Write-Host "Frontend sonar enabled AND frontend changed ‚Üí will run frontend sonar"
          }
          else {
            Write-Host "Frontend sonar disabled or no frontend changes ‚Üí skipping frontend sonar"
            echo "skipFrontendSonar=true" >> $env:GITHUB_OUTPUT
          }
          
        
          if ($frontendCoverity -eq "true" -and $frontendChanged -eq "True") {
            Write-Host "Frontend coverity enabled AND frontend changed ‚Üí will run frontend coverity"
          }
          else {
            Write-Host "Frontend coverity disabled or no frontend changes ‚Üí skipping frontend coverity"
            echo "skipFrontendCoverity=true" >> $env:GITHUB_OUTPUT
          }

          Write-Host "Validation completed."
      
  sonar-analysis:
    needs: load-validate-configuration
    runs-on: ubuntu-latest

    steps:
      # ==========================================================
      # CHECKOUT
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==========================================================
      # INSTALL RUNTIMES
      # ==========================================================
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Install SonarScanner
        run: dotnet tool install --global dotnet-sonarscanner


      # ==========================================================
      # BACKEND SONAR
      # ==========================================================
      - name: Sonar Begin (Backend)
        if: ${{ needs.load-validate-configuration.outputs.skipBackendSonar != 'true' }}
        shell: pwsh
        run: |
          # Read backend list (produced by previous Load Config step)
          $services = '${{ needs.load-validate-configuration.outputs.backendServices }}' | ConvertFrom-Json
          $configPath = Join-Path $env:GITHUB_WORKSPACE "Configurations/sonar/SonarQube.Analysis.xml"
      
          # Build inclusions list from each service.path
          $inclusionsList = @()
          foreach ($svc in $services) {
            # normalize slashes and add recursive glob
            $p = ($svc.path).Replace("\", "/").TrimEnd("/")
            # choose pattern you want Sonar to analyze (folder recursive)
            $inclusionsList += "$p/**"
          }
      
          # If nothing, leave it empty (sonar default)
          $inclusions = ""
          if ($inclusionsList.Count -gt 0) {
            $inclusions = $inclusionsList -join ","
          }
      
          Write-Host "Computed sonar.inclusions: $inclusions"
      
          # Run Sonar Begin with inclusions (if any)
          if ([string]::IsNullOrEmpty($inclusions)) {
            dotnet-sonarscanner begin `
              /k:"${{ inputs.backend_sonar_key }}" `
              /o:"${{ inputs.SONAR_ORG }}" `
              /d:sonar.host.url="${{ inputs.SONAR_HOST_URL }}" `
              /d:sonar.login="${{ secrets.SONAR_TOKEN }}" `
              /s:"$configPath"
          } else {
            dotnet-sonarscanner begin `
              /k:"${{ inputs.backend_sonar_key }}" `
              /o:"${{ inputs.SONAR_ORG }}" `
              /d:sonar.host.url="${{ inputs.SONAR_HOST_URL }}" `
              /d:sonar.login="${{ secrets.SONAR_TOKEN }}" `
              /d:sonar.inclusions="$inclusions" `
              /s:"$configPath"
          }

      - name: Build & Test Backend Services
        if: ${{ needs.load-validate-configuration.outputs.skipBackendSonar != 'true' }}
        shell: pwsh
        run: |
          $services = '${{ needs.load-validate-configuration.outputs.backendServices }}' | ConvertFrom-Json

          foreach ($svc in $services) {
            Write-Host "Backend service: $($svc.name)"
            $path = $svc.path

            # Find .sln file
            $sln = Get-ChildItem -Path $path -Filter *.sln | Select-Object -First 1

            if (-not $sln) {
              Write-Warning "No .sln found for '$($svc.name)' ‚Üí skipping"
              continue
            }

            dotnet restore $sln.FullName
            dotnet build $sln.FullName --no-restore --configuration Release
            dotnet test $sln.FullName --no-restore `
              /p:CollectCoverage=true `
              /p:CoverletOutputFormat=opencover `
              /p:CoverletOutput=./TestResults/
          }


      - name: Sonar End (Backend)
        if: ${{ needs.load-validate-configuration.outputs.skipBackendSonar != 'true' }}
        run: dotnet-sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"

      # ==========================================================
      # FRONTEND SONAR
      # ==========================================================
      - name: Sonar Scan (Frontend)
        if: ${{ needs.load-validate-configuration.outputs.skipFrontendSonar != 'true' }}
        shell: pwsh
        run: |
          # Load frontend project list
          $services = '${{ needs.load-validate-configuration.outputs.frontendProjects }}' | ConvertFrom-Json
      
          # Use existing analysis folder
          $analysisDir = Join-Path $env:GITHUB_WORKSPACE "Configurations/sonar/FrontendSonarAnalysis"
          $propsFile = "$analysisDir/sonar-project.properties"
      
          if (-not (Test-Path $propsFile)) {
            Write-Error "sonar-project.properties is missing at: $propsFile"
            exit 1
          }
      
          # Build each project first
          foreach ($svc in $services) {
            Write-Host "Building frontend project: $($svc.name)"
            $projectPath = Join-Path $env:GITHUB_WORKSPACE $svc.path
      
            if (-not (Test-Path $projectPath)) {
              Write-Warning "Project path missing: $projectPath"
              continue
            }
      
            cd $projectPath
      
            if (Test-Path "package-lock.json") {
              npm ci
            } else {
              npm install
            }
      
            if (Test-Path "package.json") {
              # build
              if ((npm run | Select-String -Pattern "build")) {
                npm run build
              } else {
                Write-Warning "No build script for project $($svc.name)"
              }
      
              # tests
              if ((npm run | Select-String -Pattern "test")) {
                npm test -- --coverage
              } else {
                Write-Warning "No test script for project $($svc.name)"
              }
            }
      
            cd $analysisDir
          }
      
          # Build dynamic sources for sonar
          $sourceList = @()
          foreach ($svc in $services) {
            $src = "$($svc.path)/src".Replace("\", "/")
            $sourceList += $src
          }
      
          $sources = ($sourceList -join ",")
      
          $baseDir = "$env:GITHUB_WORKSPACE".Replace("\", "/")
      
          Write-Host "Updating sonar-project.properties for all MFEs..."
      
          (Get-Content $propsFile |
            Where-Object {
              -not ($_ -match "^sonar\.projectBaseDir=") -and
              -not ($_ -match "^sonar\.sources=")        -and
              -not ($_ -match "^sonar\.tests=")
            }) |
            Set-Content $propsFile
      
          @"
          sonar.projectBaseDir=$baseDir
          sonar.sources=$sources
          sonar.tests=$sources
          "@ | Add-Content $propsFile
      
          Write-Host "Updated sonar-project.properties:"
          Get-Content $propsFile
      
          $env:SONAR_TOKEN    = "${{ secrets.SONAR_TOKEN }}"
          $env:SONAR_HOST_URL = "${{ inputs.SONAR_HOST_URL }}"
      
          # ---------------------------
          # Run Sonar
          # ---------------------------
          npx sonar-scanner `
            "-Dsonar.projectKey=${{ inputs.frontend_sonar_key }}" `
            "-Dsonar.organization=${{ inputs.SONAR_ORG }}" `
            "-Dsonar.host.url=$env:SONAR_HOST_URL" `
            "-Dsonar.token=$env:SONAR_TOKEN"


      # ==========================================================
      # GITHUB_STEP_SUMMARY
      # ==========================================================
      - name: Add SonarQube Report Links to Summary
        shell: pwsh
        run: |
          $backendUrl  = "https://sonarcloud.io/project/overview?id=${{ inputs.backend_sonar_key }}"
          $frontendUrl = "https://sonarcloud.io/project/overview?id=${{ inputs.frontend_sonar_key }}"
      
          @"
          # SonarQube Analysis Summary
          
          ## Backend Analysis
          - **Project Key:** `${{ inputs.backend_sonar_key }}`
          - **Report URL:** [$backendUrl]($backendUrl)
          
          ## Frontend Analysis
          - **Project Key:** `${{ inputs.frontend_sonar_key }}`
          - **Report URL:** [$frontendUrl]($frontendUrl)
          
          üìù Click the links above to view code smells, bugs, vulnerabilities, and coverage.
          "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          
          
  coverity-analysis:
    needs: load-validate-configuration 
    runs-on: ubuntu-latest
    
    steps:
      # ==========================================================
      # CHECKOUT
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==========================================================
      # DOWNLOAD COVERITY
      # ==========================================================
      - name: Download Coverity Tools
        run: |
          wget -q https://scan.coverity.com/download/linux64 --post-data "token=${{ secrets.COVERITY_BACKEND_PROJECT_TOKEN }}&project=Device+Monitoring+Backends+Git" -O coverity_tool.tgz

      - name: Extract Coverity Tools
        run: |
          mkdir coverity
          tar -zxvf coverity_tool.tgz -C coverity --strip-components=1

      # ==========================================================
      # BUILD FOR COVERITY - BACKEND
      # ==========================================================
      - name: Coverity Build
        if: ${{ needs.load-validate-configuration.outputs.skipBackendCoverity != 'true' }}
        shell: pwsh
        run: |
          $services = '${{ needs.load-validate-configuration.outputs.backendServices }}' | ConvertFrom-Json
        
          $buildCommands = @()
          foreach ($svc in $services) {
            $rel = $svc.path.Replace("\", "/")
            $full = Join-Path $env:GITHUB_WORKSPACE $rel
            $buildCommands += "dotnet restore $full && dotnet build $full --no-incremental --configuration Debug"
          }
        
          $buildCommand = ($buildCommands -join " && ")
        
          Write-Host "Running Coverity build:"
          Write-Host $buildCommand
        
          ./coverity/bin/cov-build --dir cov-int bash -c "$buildCommand"

      # ==========================================================
      # PACKAGE FOR UPLOAD
      # ==========================================================
      - name: Create Zip
        if: ${{ needs.load-validate-configuration.outputs.skipBackendCoverity != 'true' }}
        run: tar czvf cov-int.tgz cov-int

      - name: Upload to Coverity Scan
        if: ${{ needs.load-validate-configuration.outputs.skipBackendCoverity != 'true' }}
        run: |
          curl \
            --form token=${{ secrets.COVERITY_BACKEND_PROJECT_TOKEN }} \
            --form email=${{ inputs.COVERITY_EMAIL }} \
            --form file=@cov-int.tgz \
            https://scan.coverity.com/builds?project=Device+Monitoring+Backends+Git
            
      # ==========================================================
      # CLEANUP HERE - REMOVE COV INT AND TGZ
      # ==========================================================
      - name: Cleanup Coverity Backend Capture
        if: ${{ needs.load-validate-configuration.outputs.skipBackendCoverity != 'true' }}
        run: |
          rm -rf cov-int cov-int.tgz
              
      # ==========================================================
      # BUILD FOR COVERITY - FRONTEND
      # ==========================================================
      - name: Run Coverity Buildless Capture
        if: ${{ needs.load-validate-configuration.outputs.skipFrontendCoverity != 'true' }}
        run: |
          ./coverity/bin/coverity capture --dir cov-int --project-dir "$GITHUB_WORKSPACE/Frontend" --file-exclude-regex ".*/node_modules/.*|.*\.next/.*|.*/out/.*|.*/dist/.*|.*/coverage/.*|.*\.(test|spec)\.(ts|tsx|js|jsx)$|.*\.stories\.(ts|tsx|js|jsx)$|.*/__tests__/.*"
          
      # ==========================================================
      # PACKAGE FOR UPLOAD
      # ==========================================================
      - name: Create Zip
        if: ${{ needs.load-validate-configuration.outputs.skipFrontendCoverity != 'true' }}
        run: tar czvf cov-int.tgz cov-int

      - name: Upload to Coverity Scan
        if: ${{ needs.load-validate-configuration.outputs.skipFrontendCoverity != 'true' }}
        run: |
          curl \
            --form token=${{ secrets.COVERITY_FRONTEND_PROJECT_TOKEN }} \
            --form email=${{ inputs.COVERITY_EMAIL }} \
            --form file=@cov-int.tgz \
            https://scan.coverity.com/builds?project=Device+Monitoring+Frontends+Git
