name: generic-ci

on:
  workflow_call:
    secrets:
      SONAR_TOKEN:
        required: true
      COVERITY_BACKEND_PROJECT_TOKEN:
        required: true
      COVERITY_FRONTEND_PROJECT_TOKEN:
        required: true
    inputs:
      backend_sonar_key:
        type: string
        required: true
      frontend_sonar_key:
        type: string
        required: true
      SONAR_HOST_URL:
        type: string
        required: true
      SONAR_ORG:
        type: string
        required: true
      COVERITY_EMAIL:
        type: string
        required: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend_changed: ${{ steps.changes.outputs.backendChanged }}
      frontend_changed: ${{ steps.changes.outputs.frontendChanged }}

    steps:
      # ==========================================================
      # CHECKOUT
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # ==========================================================
      # DETECT CHANGES (AUTO-ENABLE BACKEND/FRONTEND SONAR)
      # ==========================================================
      - name: Detect Changed Backend/Frontend Projects
        id: changes
        shell: pwsh
        run: |
          Write-Host "Detecting changed files..."

          # Get list of changed files in PR or push
          $changedFiles = git diff --name-only HEAD~1 HEAD

          Write-Host "Changed files:"
          Write-Host $changedFiles

          # Parse config
          $configJson = yq -o=json '.' Configurations/project-config.yml
          $config = $configJson | ConvertFrom-Json

          $backendChanged = $false
          $frontendChanged = $false

          # -----------------------------------
          # Detect backend changes
          # -----------------------------------
          foreach ($svc in $config.backendServices) {
            $path = $svc.path.Replace("\", "/")
            if ($changedFiles -match $path) {
              Write-Host "Backend project changed: $($svc.name)"
              $backendChanged = $true
            }
          }

          # -----------------------------------
          # Detect frontend changes
          # -----------------------------------
          foreach ($svc in $config.frontendProjects) {
            $path = $svc.path.Replace("\", "/")
            if ($changedFiles -match $path) {
              Write-Host "Frontend project changed: $($svc.name)"
              $frontendChanged = $true
            }
          }

          # Output results (true/false)
          echo "backendChanged=$backendChanged"   >> $env:GITHUB_OUTPUT
          echo "frontendChanged=$frontendChanged" >> $env:GITHUB_OUTPUT

          Write-Host "backendChanged = $backendChanged"
          Write-Host "frontendChanged = $frontendChanged"
          
          
  load-validate-configuration:
    needs: detect-changes
    runs-on: ubuntu-latest
    outputs:
      skipBackendSonar: ${{ steps.validate.outputs.skipBackendSonar }}
      skipBackendCoverity: ${{ steps.validate.outputs.skipBackendCoverity }}
      skipBackendSbom: ${{ steps.validate.outputs.skipBackendSbom }}
      skipFrontendSonar: ${{ steps.validate.outputs.skipFrontendSonar }}
      skipFrontendCoverity: ${{ steps.validate.outputs.skipFrontendCoverity }}
      skipFrontendSbom: ${{ steps.validate.outputs.skipFrontendSbom }}
      backendServices: ${{ steps.config.outputs.backend }}
      frontendProjects: ${{ steps.config.outputs.frontend }}
      backendCoverityProjectName: ${{ steps.config.outputs.backendCoverityProjectName }}
      backendCoverityProjectUrlName: ${{ steps.config.outputs.backendCoverityProjectUrlName }}
      frontendCoverityProjectName: ${{ steps.config.outputs.frontendCoverityProjectName }}
      frontendCoverityProjectUrlName: ${{ steps.config.outputs.frontendCoverityProjectUrlName }}

    steps:
      # ==========================================================
      # CHECKOUT
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      # ==========================================================
      # LOAD CONFIG
      # ==========================================================
      - name: Load Configurations
        id: config
        run: |
          CONFIG="Configurations/project-config.yml"
      
          echo "backend=$(yq -o=json -I=0 '.backendServices' $CONFIG)" >> $GITHUB_OUTPUT
          echo "frontend=$(yq -o=json -I=0 '.frontendProjects' $CONFIG)" >> $GITHUB_OUTPUT
          echo "backendSonarRaw=$(yq '.settings.backend.sonar' $CONFIG)" >> $GITHUB_OUTPUT
          echo "frontendSonarRaw=$(yq '.settings.frontend.sonar' $CONFIG)" >> $GITHUB_OUTPUT
          echo "backendCoverityRaw=$(yq '.settings.backend.coverity' $CONFIG)" >> $GITHUB_OUTPUT
          echo "frontendCoverityRaw=$(yq '.settings.frontend.coverity' $CONFIG)" >> $GITHUB_OUTPUT
          echo "backendSbomRaw=$(yq '.settings.backend.sbom' $CONFIG)" >> $GITHUB_OUTPUT
          echo "frontendSbomRaw=$(yq '.settings.frontend.sbom' $CONFIG)" >> $GITHUB_OUTPUT
          echo "backendCoverityProjectName=$(yq '.settings.backend.coverity_project_name' $CONFIG)" >> $GITHUB_OUTPUT
          echo "backendCoverityProjectUrlName=$(yq '.settings.backend.coverity_project_url_name' $CONFIG)" >> $GITHUB_OUTPUT
          echo "frontendCoverityProjectName=$(yq '.settings.frontend.coverity_project_name' $CONFIG)" >> $GITHUB_OUTPUT
          echo "frontendCoverityProjectUrlName=$(yq '.settings.frontend.coverity_project_url_name' $CONFIG)" >> $GITHUB_OUTPUT
          
      
          echo "=== DEBUG PRINTS FROM Load Configurations ==="
          echo "backendServices:"
          yq -o=json -I=0 '.backendServices' $CONFIG
      
          echo "frontendProjects:"
          yq -o=json -I=0 '.frontendProjects' $CONFIG
      
          echo "backend.sonar:"
          yq '.settings.backend.sonar' $CONFIG
      
          echo "frontend.sonar:"
          yq '.settings.frontend.sonar' $CONFIG
          
      # ==========================================================
      # VALIDATION (CRITICAL)
      # ==========================================================
      - name: Validate Configuration
        id: validate
        shell: pwsh
        run: |  
          function Normalize-Bool($value) {
            if ([string]::IsNullOrWhiteSpace($value)) { return "false" }
            return $value
          }
          
          function Apply-SkipRule($Name, $Enabled, $Changed, $SkipKey) {
            if ($Enabled -eq "true" -and $Changed -eq "True") {
              Write-Host "$Name enabled AND changes detected ‚Üí will run"
            }
            else {
              Write-Host "$Name disabled or no changes ‚Üí skipping"
              echo "$SkipKey=true" >> $env:GITHUB_OUTPUT
            }
          }      

          # 1. Check config file exists
          if (-not (Test-Path "Configurations/project-config.yml")) {
            Write-Error "Missing Configurations/project-config.yml. Cannot continue."
            exit 1
          }

          # Load YAML
          $configJson = yq -o=json '.' Configurations/project-config.yml
          $config = $configJson | ConvertFrom-Json
          $backendProjectsAvailable = $config.backendServices -or $config.backendServices.Count -eq 0
          $frontendProjectsAvailable = $config.frontendProjects -or $config.frontendProjects.Count -eq 0

          # =====================================================
          # BACKEND VALIDATION
          # =====================================================
          $backendSonar = Normalize-Bool "${{ steps.config.outputs.backendSonarRaw }}"
          echo "backendSonar=$backendSonar" >> $env:GITHUB_OUTPUT
    
          if ($backendSonar -eq "true") {
            # Must have services
            if (-not $backendProjectsAvailable) {
              Write-Warning "backendServices is empty ‚Üí skipping backend sonar"
              echo "skipBackendSonar=true" >> $env:GITHUB_OUTPUT
            }

            # Must have backend sonar config
            if (-not (Test-Path "Configurations/sonar/SonarQube.Analysis.xml")) {
              Write-Error "Missing backend sonar config: Configurations/sonar/SonarQube.Analysis.xml"
              exit 1
            }
          }
          
          $backendCoverity = Normalize-Bool "${{ steps.config.outputs.backendCoverityRaw }}"
          echo "backendCoverity=$backendCoverity" >> $env:GITHUB_OUTPUT
    
          if ($backendCoverity -eq "true") {
            # Must have services
            if (-not $backendProjectsAvailable) {
              Write-Warning "backendServices is empty ‚Üí skipping backend Coverity"
              echo "skipBackendCoverity=true" >> $env:GITHUB_OUTPUT
            }
          }
          
          $backendSbom = Normalize-Bool "${{ steps.config.outputs.   }}"
          echo "backendSbom=$backendSbom" >> $env:GITHUB_OUTPUT
    
          if ($backendSbom -eq "true") {
            # Must have services
            if (-not $backendProjectsAvailable) {
              Write-Warning "backendServices is empty ‚Üí skipping backend Sbom"
              echo "skipBackendSbom=true" >> $env:GITHUB_OUTPUT
            }
          }

          # Skip backend sonar if no changes detected
          Apply-SkipRule "Backend Sonar" $backendSonar backendChanged "skipBackendSonar"
          
          # Skip backend coverity if no project name found in configurations
          $backendCoverityProjectName = "${{ steps.config.outputs.backendCoverityProjectName }}"
          if ($backendCoverityProjectName -eq "" -or $null -eq $backendCoverityProjectName) {
            Write-Host "settings.backend.coverity_project_name not found ‚Üí treating as null"
            $backendCoverity = "false"
          }
          
          # Skip backend coverity if no changes detected
          Apply-SkipRule "Backend Coverity" $backendCoverity backendChanged "skipBackendCoverity"
          
          # Skip backend sbom if no changes detected
          Apply-SkipRule "Backend SBOM" $backendSbom backendChanged "skipBackendSbom"

          # =====================================================
          # FRONTEND VALIDATION
          # =====================================================
          $frontendSonar = Normalize-Bool "${{ steps.config.outputs.frontendSonarRaw }}"
          echo "frontendSonar=$frontendSonar" >> $env:GITHUB_OUTPUT

          if ($frontendSonar -eq "true") {
            # Must have projects
            if (-not $frontendProjectsAvailable) {
              Write-Warning "frontendProjects empty ‚Üí skipping frontend sonar"
              echo "skipFrontendSonar=true" >> $env:GITHUB_OUTPUT
            }

            # Must have frontend sonar config
            if (-not (Test-Path "Configurations/sonar/FrontendSonarAnalysis/sonar-project.properties")) {
              Write-Warning "Missing frontend sonar config ‚Üí skipping frontend sonar"
              echo "skipFrontendSonar=true" >> $env:GITHUB_OUTPUT
            }
          }
          
          $frontendCoverity = Normalize-Bool "${{ steps.config.outputs.frontendCoverityRaw }}"
          echo "frontendCoverity=$frontendCoverity" >> $env:GITHUB_OUTPUT

          if ($frontendCoverity -eq "true") {
            # Must have projects
            if (-not $frontendProjectsAvailable) {
              Write-Warning "frontendProjects empty ‚Üí skipping frontend sonar"
              echo "skipFrontendCoverity=true" >> $env:GITHUB_OUTPUT
            }
          }
          
          $frontendSbom = Normalize-Bool "${{ steps.config.outputs.frontendSbomRaw }}"
          echo "frontendSbom=$frontendSbom" >> $env:GITHUB_OUTPUT

          if ($frontendSbom -eq "true") {
            # Must have projects
            if (-not $frontendProjectsAvailable) {
              Write-Warning "frontendProjects empty ‚Üí skipping frontend sbom"
              echo "skipFrontendSbom=true" >> $env:GITHUB_OUTPUT
            }
          }

          $frontendChanged = "${{ needs.detect-changes.outputs.frontend_changed }}"
          Apply-SkipRule "Frontend Sonar" $frontendSonar frontendChanged "skipFrontendSonar"
        
          # Skip frontend coverity if no project name found in configurations
          $frontendCoverityProjectName = "${{ steps.config.outputs.frontendCoverityProjectName }}"
          if ($frontendCoverityProjectName -eq "" -or $null -eq $frontendCoverityProjectName) {
            Write-Host "settings.frontend.coverity_project_name not found ‚Üí treating as null"
            $frontendCoverity = "false"
          }
          
          Apply-SkipRule "Frontend Coverity" $frontendCoverity frontendChanged "skipFrontendCoverity"
          
          Apply-SkipRule "Frontend SBOM" $frontendSbom frontendChanged "skipFrontendSbom"
          Write-Host "Validation completed."
      
  sonar-analysis:
    needs: load-validate-configuration
    if: ${{ needs.load-validate-configuration.outputs.skipBackendSonar != 'true' || needs.load-validate-configuration.outputs.skipFrontendSonar != 'true' }}
    runs-on: ubuntu-latest

    steps:
      # ==========================================================
      # CHECKOUT
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==========================================================
      # INSTALL RUNTIMES
      # ==========================================================
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Install SonarScanner
        run: dotnet tool install --global dotnet-sonarscanner


      # ==========================================================
      # BACKEND SONAR
      # ==========================================================
      - name: Sonar Begin (Backend)
        if: ${{ needs.load-validate-configuration.outputs.skipBackendSonar != 'true' }}
        shell: pwsh
        run: |
          # Read backend list (produced by previous Load Config step)
          $services = '${{ needs.load-validate-configuration.outputs.backendServices }}' | ConvertFrom-Json
          $configPath = Join-Path $env:GITHUB_WORKSPACE "Configurations/sonar/SonarQube.Analysis.xml"
      
          # Build inclusions list from each service.path
          $inclusionsList = @()
          foreach ($svc in $services) {
            # normalize slashes and add recursive glob
            $p = ($svc.path).Replace("\", "/").TrimEnd("/")
            # choose pattern you want Sonar to analyze (folder recursive)
            $inclusionsList += "$p/**"
          }
      
          # If nothing, leave it empty (sonar default)
          $inclusions = ""
          if ($inclusionsList.Count -gt 0) {
            $inclusions = $inclusionsList -join ","
          }
      
          Write-Host "Computed sonar.inclusions: $inclusions"
      
          # Run Sonar Begin with inclusions (if any)
          if ([string]::IsNullOrEmpty($inclusions)) {
            dotnet-sonarscanner begin `
              /k:"${{ inputs.backend_sonar_key }}" `
              /o:"${{ inputs.SONAR_ORG }}" `
              /d:sonar.host.url="${{ inputs.SONAR_HOST_URL }}" `
              /d:sonar.login="${{ secrets.SONAR_TOKEN }}" `
              /s:"$configPath"
          } else {
            dotnet-sonarscanner begin `
              /k:"${{ inputs.backend_sonar_key }}" `
              /o:"${{ inputs.SONAR_ORG }}" `
              /d:sonar.host.url="${{ inputs.SONAR_HOST_URL }}" `
              /d:sonar.login="${{ secrets.SONAR_TOKEN }}" `
              /d:sonar.inclusions="$inclusions" `
              /s:"$configPath"
          }

      - name: Build & Test Backend Services
        if: ${{ needs.load-validate-configuration.outputs.skipBackendSonar != 'true' }}
        shell: pwsh
        run: |
          $services = '${{ needs.load-validate-configuration.outputs.backendServices }}' | ConvertFrom-Json

          foreach ($svc in $services) {
            Write-Host "Backend service: $($svc.name)"
            $path = $svc.path

            # Find .sln file
            $sln = Get-ChildItem -Path $path -Filter *.sln | Select-Object -First 1

            if (-not $sln) {
              Write-Warning "No .sln found for '$($svc.name)' ‚Üí skipping"
              continue
            }

            dotnet restore $sln.FullName
            dotnet build $sln.FullName --no-restore --configuration Release
            dotnet test $sln.FullName --no-restore `
              /p:CollectCoverage=true `
              /p:CoverletOutputFormat=opencover `
              /p:CoverletOutput=./TestResults/
          }


      - name: Sonar End (Backend)
        if: ${{ needs.load-validate-configuration.outputs.skipBackendSonar != 'true' }}
        run: dotnet-sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"

      # ==========================================================
      # FRONTEND SONAR
      # ==========================================================
      - name: Sonar Scan (Frontend)
        if: ${{ needs.load-validate-configuration.outputs.skipFrontendSonar != 'true' }}
        shell: pwsh
        run: |
          # Load frontend project list
          $services = '${{ needs.load-validate-configuration.outputs.frontendProjects }}' | ConvertFrom-Json
      
          # Use existing analysis folder
          $analysisDir = Join-Path $env:GITHUB_WORKSPACE "Configurations/sonar/FrontendSonarAnalysis"
          $propsFile = "$analysisDir/sonar-project.properties"
      
          if (-not (Test-Path $propsFile)) {
            Write-Error "sonar-project.properties is missing at: $propsFile"
            exit 1
          }
      
          # Build each project first
          foreach ($svc in $services) {
            Write-Host "Building frontend project: $($svc.name)"
            $projectPath = Join-Path $env:GITHUB_WORKSPACE $svc.path
      
            if (-not (Test-Path $projectPath)) {
              Write-Warning "Project path missing: $projectPath"
              continue
            }
      
            cd $projectPath
      
            if (Test-Path "package-lock.json") {
              npm ci
            } else {
              npm install
            }
      
            if (Test-Path "package.json") {
              # build
              if ((npm run | Select-String -Pattern "build")) {
                npm run build
              } else {
                Write-Warning "No build script for project $($svc.name)"
              }
      
              # tests
              if ((npm run | Select-String -Pattern "test")) {
                npm test -- --coverage
              } else {
                Write-Warning "No test script for project $($svc.name)"
              }
            }
      
            cd $analysisDir
          }
      
          # Build dynamic sources for sonar
          $sourceList = @()
          foreach ($svc in $services) {
            $src = "$($svc.path)/src".Replace("\", "/")
            $sourceList += $src
          }
      
          $sources = ($sourceList -join ",")
      
          $baseDir = "$env:GITHUB_WORKSPACE".Replace("\", "/")
      
          Write-Host "Updating sonar-project.properties for all MFEs..."
      
          (Get-Content $propsFile |
            Where-Object {
              -not ($_ -match "^sonar\.projectBaseDir=") -and
              -not ($_ -match "^sonar\.sources=")        -and
              -not ($_ -match "^sonar\.tests=")
            }) |
            Set-Content $propsFile
      
          @"
          sonar.projectBaseDir=$baseDir
          sonar.sources=$sources
          sonar.tests=$sources
          "@ | Add-Content $propsFile
      
          Write-Host "Updated sonar-project.properties:"
          Get-Content $propsFile
      
          $env:SONAR_TOKEN    = "${{ secrets.SONAR_TOKEN }}"
          $env:SONAR_HOST_URL = "${{ inputs.SONAR_HOST_URL }}"
      
          # ---------------------------
          # Run Sonar
          # ---------------------------
          npx sonar-scanner `
            "-Dsonar.projectKey=${{ inputs.frontend_sonar_key }}" `
            "-Dsonar.organization=${{ inputs.SONAR_ORG }}" `
            "-Dsonar.host.url=$env:SONAR_HOST_URL" `
            "-Dsonar.token=$env:SONAR_TOKEN"

             
  coverity-analysis:
    needs: load-validate-configuration 
    if: ${{ needs.load-validate-configuration.outputs.skipBackendCoverity != 'true' || needs.load-validate-configuration.outputs.skipFrontendCoverity != 'true' }}
    runs-on: ubuntu-latest
    
    steps:
      # ==========================================================
      # CHECKOUT
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==========================================================
      # DOWNLOAD COVERITY
      # ==========================================================
      - name: Download Coverity Tools
        run: |
          wget -q https://scan.coverity.com/download/linux64 --post-data "token=${{ secrets.COVERITY_BACKEND_PROJECT_TOKEN }}&project=${{ needs.load-validate-configuration.outputs.backendCoverityProjectName }}" -O coverity_tool.tgz

      - name: Extract Coverity Tools
        run: |
          mkdir coverity
          tar -zxvf coverity_tool.tgz -C coverity --strip-components=1

      # ==========================================================
      # BUILD FOR COVERITY - BACKEND
      # ==========================================================
      - name: Coverity Build
        if: ${{ needs.load-validate-configuration.outputs.skipBackendCoverity != 'true' }}
        shell: pwsh
        run: |
          $services = '${{ needs.load-validate-configuration.outputs.backendServices }}' | ConvertFrom-Json
        
          $buildCommands = @()
          foreach ($svc in $services) {
            $rel = $svc.path.Replace("\", "/")
            $full = Join-Path $env:GITHUB_WORKSPACE $rel
            $buildCommands += "dotnet restore $full && dotnet build $full --no-incremental --configuration Debug"
          }
        
          $buildCommand = ($buildCommands -join " && ")
        
          Write-Host "Running Coverity build:"
          Write-Host $buildCommand
        
          ./coverity/bin/cov-build --dir cov-int bash -c "$buildCommand"

      # ==========================================================
      # PACKAGE FOR UPLOAD
      # ==========================================================
      - name: Create Zip
        if: ${{ needs.load-validate-configuration.outputs.skipBackendCoverity != 'true' }}
        run: tar czvf cov-int.tgz cov-int

      - name: Upload to Coverity Scan
        if: ${{ needs.load-validate-configuration.outputs.skipBackendCoverity != 'true' }}
        run: |
          curl \
            --form token=${{ secrets.COVERITY_BACKEND_PROJECT_TOKEN }} \
            --form email=${{ inputs.COVERITY_EMAIL }} \
            --form file=@cov-int.tgz \
            https://scan.coverity.com/builds?project=${{ needs.load-validate-configuration.outputs.backendCoverityProjectName }}
            
      # ==========================================================
      # CLEANUP HERE - REMOVE COV INT AND TGZ
      # ==========================================================
      - name: Cleanup Coverity Backend Capture
        if: ${{ needs.load-validate-configuration.outputs.skipBackendCoverity != 'true' }}
        run: |
          rm -rf cov-int cov-int.tgz
              
      # ==========================================================
      # BUILD FOR COVERITY - FRONTEND
      # ==========================================================
      - name: Run Coverity Buildless Capture
        if: ${{ needs.load-validate-configuration.outputs.skipFrontendCoverity != 'true' }}
        run: |
          echo "The workspace path is: $GITHUB_WORKSPACE/Frontend"
          ./coverity/bin/coverity capture --dir cov-int --project-dir "$GITHUB_WORKSPACE/Frontend" --file-exclude-regex ".*(certificates|node_modules|\.next|env|out|dist|coverage|__tests__).*|.*\.(test|spec|stories)\.(ts|tsx|js|jsx)$"
          
      # ==========================================================
      # PACKAGE FOR UPLOAD
      # ==========================================================
      - name: Create Zip
        if: ${{ needs.load-validate-configuration.outputs.skipFrontendCoverity != 'true' }}
        run: tar czvf cov-int.tgz cov-int

      - name: Upload to Coverity Scan
        if: ${{ needs.load-validate-configuration.outputs.skipFrontendCoverity != 'true' }}
        run: |
          curl \
            --form token=${{ secrets.COVERITY_FRONTEND_PROJECT_TOKEN }} \
            --form email=${{ inputs.COVERITY_EMAIL }} \
            --form file=@cov-int.tgz \
            https://scan.coverity.com/builds?project=${{ needs.load-validate-configuration.outputs.frontendCoverityProjectName }}
            
            
  sbom-analysis:
    needs: load-validate-configuration 
    if: ${{ needs.load-validate-configuration.outputs.skipBackendSbom != 'true' || needs.load-validate-configuration.outputs.skipFrontendSbom != 'true' }}
    runs-on: ubuntu-latest
    
    steps:
      # ==========================================================
      # CHECKOUT
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x
      
      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install SBOM Tool
        run: dotnet tool install --global Microsoft.Sbom.DotNetTool
        
      - name: Create base output folders
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "./artifacts" -Force | Out-Null
          New-Item -ItemType Directory -Path "./sbom" -Force | Out-Null
          
      - name: Generate SBOM (Backend)
        if: ${{ needs.load-validate-configuration.outputs.skipBackendSbom != 'true' }}
        shell: pwsh
        run: |
          $services = '${{ needs.load-validate-configuration.outputs.backendServices }}' | ConvertFrom-Json

          foreach ($svc in $services) {

            $servicePath = "$($svc.path)".Replace("\", "/")
            $serviceDir  = Join-Path $env:GITHUB_WORKSPACE $servicePath

            # Find .sln
            $sln = Get-ChildItem -Path $serviceDir -Filter *.sln -File | Select-Object -First 1
            if (-not $sln) {
              Write-Warning "No .sln found in $serviceDir ‚Üí skipping SBOM for $($svc.name)"
              continue
            }

            $serviceName = $svc.name

            Write-Host "`n============ Processing $serviceName ============"

            # Create output folders
            New-Item -ItemType Directory -Path "./artifacts/$serviceName" -Force | Out-Null
            New-Item -ItemType Directory -Path "./sbom/$serviceName" -Force | Out-Null

            # Build service
            dotnet build $sln.FullName -c Release -o "./artifacts/$serviceName"

            # Generate SBOM
            sbom-tool generate `
              -b "./artifacts/$serviceName" `
              -bc $serviceDir `
              -pn $serviceName `
              -pv "1.0.0" `
              -ps "Premal Kadam" `
              -m "./sbom/$serviceName"
          }
          
      - name: Generate SBOM (Frontend)
        if: ${{ needs.load-validate-configuration.outputs.skipFrontendSbom != 'true' }}
        shell: pwsh
        run: |
          $projects = '${{ needs.load-validate-configuration.outputs.frontendProjects }}' | ConvertFrom-Json

          foreach ($proj in $projects) {

            $projectPath = "$($proj.path)".Replace("\", "/")
            $projectDir  = Join-Path $env:GITHUB_WORKSPACE $projectPath
            $projectName = $proj.name

            Write-Host "`n============ Processing Frontend: $projectName ============"

            # Create output folders
            New-Item -ItemType Directory -Path "./artifacts/$projectName" -Force | Out-Null
            New-Item -ItemType Directory -Path "./sbom/$projectName" -Force | Out-Null

            # Install & build
            npm install  --prefix $projectDir
            npm run build --prefix $projectDir

            # Copy built output (.next, dist, etc.)
            if (Test-Path "$projectDir/.next") {
              Copy-Item "$projectDir/.next" "./artifacts/$projectName" -Recurse -Force
            }
            elseif (Test-Path "$projectDir/dist") {
              Copy-Item "$projectDir/dist" "./artifacts/$projectName" -Recurse -Force
            }
            elseif (Test-Path "$projectDir/build") {
              Copy-Item "$projectDir/build" "./artifacts/$projectName" -Recurse -Force
            }
            else {
              Write-Warning "No frontend build output found (.next/dist/build). SBOM may be empty."
            }

            # Generate SBOM
            sbom-tool generate `
              -b "./artifacts/$projectName" `
              -bc $projectDir `
              -pn $projectName `
              -pv "1.0.0" `
              -ps "Premal Kadam" `
              -m "./sbom/$projectName"
          }
          
      - name: Upload all SBOM Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SBOMs
          path: |
            sbom/*/_manifest/spdx_2.2/manifest.spdx.json
            
            
            
  github-summary:
    needs: load-validate-configuration 
    name: Generate Pipeline Summary
    runs-on: ubuntu-latest

    steps:
      - name: Generate CI Summary
        shell: pwsh
        run: |
          # Build Sonar URLs
          $backendSonarUrl  = "https://sonarcloud.io/project/overview?id=premalwonderbiz_DeviceMonitoringProject_Backend"
          $frontendSonarUrl = "https://sonarcloud.io/project/overview?id=premalwonderbiz_DeviceMonitoringProject_Frontend"
        
          # Coverity project names
          $backendCovKey  = "device-monitoring-backends-git"
          $frontendCovKey = "device-monitoring-frontends-git"
        
          Write-Host "Backend Coverity Key: $backendCovKey"
          Write-Host "Frontend Coverity Key: $frontendCovKey"
        
          # Build Coverity URLs only if keys provided
          if ([string]::IsNullOrWhiteSpace($backendCovKey)) {
            $backendCoveritySection = "- **Coverity:** Disabled or not configured"
          } else {
            $backendCoverityUrl = "https://scan.coverity.com/projects/$backendCovKey`?tab=overview"
            Write-Host "Backend Coverity URL: $backendCoverityUrl"
            $backendCoveritySection = "- **Coverity Report:** [$backendCoverityUrl]($backendCoverityUrl)"
          }
        
          if ([string]::IsNullOrWhiteSpace($frontendCovKey)) {
            $frontendCoveritySection = "- **Coverity:** Disabled or not configured"
          } else {
            $frontendCoverityUrl = "https://scan.coverity.com/projects/$frontendCovKey`?tab=overview"
            Write-Host "Frontend Coverity URL: $frontendCoverityUrl"
            $frontendCoveritySection = "- **Coverity Report:** [$frontendCoverityUrl]($frontendCoverityUrl)"
          }
        
          # Create the summary
          $summary = @"
          # CI Quality Analysis Summary
        
          ## üîç SonarQube Analysis
        
          ### Backend
          - **Project Key:** ``premalwonderbiz_DeviceMonitoringProject_Backend``
          - **Report:** [$backendSonarUrl]($backendSonarUrl)
        
          ### Frontend
          - **Project Key:** ``premalwonderbiz_DeviceMonitoringProject_Frontend``
          - **Report:** [$frontendSonarUrl]($frontendSonarUrl)
        
          ---
        
          ## üõ°Ô∏è Coverity Static Analysis
        
          ### Backend
          $backendCoveritySection
        
          ### Frontend
          $frontendCoveritySection
        
          ---
        
          ## üì¶ SBOM Output
          SBOM files were generated per project and uploaded as workflow artifacts.
        
          #### Note: 
          Once analysis is completed you can check latest reports via above links
          "@
        
          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
